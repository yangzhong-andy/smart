<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç©ºç³»ç»Ÿæ•°æ®</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    h1 {
      color: #f1f5f9;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .status {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }
    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }
    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }
    button:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .stats {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 13px;
      color: #94a3b8;
    }
    .stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—‘ï¸ æ¸…ç©ºç³»ç»Ÿæ•°æ®</h1>
    
    <div id="status" class="status info">
      å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¸…ç©ºæ‰€æœ‰æ•°æ®
    </div>

    <button id="clearBtn" onclick="clearAllData()">
      æ¸…ç©ºæ‰€æœ‰æ•°æ®
    </button>

    <div class="stats" id="stats"></div>
  </div>

  <script>
    // æ‰€æœ‰ localStorage key åˆ—è¡¨
    const ALL_STORAGE_KEYS = [
      // å¹¿å‘Šä»£ç†ç›¸å…³
      "adAgencies",
      "adAccounts",
      "adConsumptions",
      "adRecharges",
      "adAgencyMockDataInitialized",
      
      // è´¢åŠ¡ç›¸å…³
      "bankAccounts",
      "monthlyBills",
      "paymentRequests",
      "cashFlow",
      "rebateReceivables",
      
      // é‡‡è´­ç›¸å…³
      "purchaseContracts",
      "purchaseOrders",
      "deliveryOrders",
      
      // äº§å“ç›¸å…³
      "products",
      
      // è¾¾äººBDç›¸å…³
      "influencerBD",
      
      // äººåŠ›èµ„æºç›¸å…³
      "hr_employees",
      "hr_commission_rules",
      "hr_commission_records",
      
      // ç‰©æµç›¸å…³
      "logisticsChannels",
      "logisticsTracking",
      "pendingInbound",
      "outboundOrders", // å‡ºåº“å•
      "outboundBatches", // å‡ºåº“æ‰¹æ¬¡
      "warehouses", // ä»“åº“ä¿¡æ¯
      
      // ä¾›åº”å•†ç›¸å…³
      "suppliers", // ä¾›åº”å•†åº“ï¼ˆä¸»è¦æ•°æ®ï¼‰
      "supplierProfiles",
      "supplierMonthlyBills",
      "supplierPayments",
      
      // ä¾›åº”é“¾ç›¸å…³
      "orderTracking",
      "batchReceipts",
      "documents",
      "salesVelocity",
      
      // åº—é“ºç›¸å…³
      "stores",
      
      // ä¸šåŠ¡å…³ç³»
      "businessRelations",
      
      // é€šçŸ¥ç›¸å…³
      "notifications",
      
      // å¾…å¤„ç†ç›¸å…³
      "pendingEntries",
      
      // ç‰©æµç›¸å…³ï¼ˆæ–°å¢ï¼‰
      "outboundOrders", // å‡ºåº“å•
      "outboundBatches", // å‡ºåº“æ‰¹æ¬¡
      "warehouses", // ä»“åº“ä¿¡æ¯
      
      // ä¸´æ—¶æ¸…ç†æ ‡è®°
      "CLEAR_FINANCE_DATA",
      "CLEAR_STORES_DATA",
      "CLEAR_ALL_TEST_DATA",
      
      // åˆå§‹åŒ–æ ‡è®°
      "cashFlowInitialized",
      "storesInitialized",
    ];

    function updateStats() {
      const statsDiv = document.getElementById('stats');
      let totalSize = 0;
      let totalKeys = 0;

      ALL_STORAGE_KEYS.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) {
          totalSize += new Blob([value]).size;
          totalKeys++;
        }
      });

      const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      };

      statsDiv.innerHTML = `
        <div class="stats-item">
          <span>æ•°æ®é¡¹æ•°é‡ï¼š</span>
          <span>${totalKeys} é¡¹</span>
        </div>
        <div class="stats-item">
          <span>æ€»å­˜å‚¨å¤§å°ï¼š</span>
          <span>${formatSize(totalSize)}</span>
        </div>
      `;
    }

    function clearAllData() {
      const statusDiv = document.getElementById('status');
      const clearBtn = document.getElementById('clearBtn');

      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºç³»ç»Ÿæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼ŒåŒ…æ‹¬è®¢å•ã€è´¦å•ã€äº§å“ã€è´¢åŠ¡è®°å½•ç­‰ã€‚\n\nç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        return;
      }

      clearBtn.disabled = true;
      statusDiv.className = 'status info';
      statusDiv.textContent = 'æ­£åœ¨æ¸…ç©ºæ•°æ®...';

      let clearedCount = 0;
      let errorCount = 0;

      ALL_STORAGE_KEYS.forEach(key => {
        try {
          if (localStorage.getItem(key) !== null) {
            localStorage.removeItem(key);
            clearedCount++;
          }
        } catch (e) {
          console.error(`Failed to remove key: ${key}`, e);
          errorCount++;
        }
      });

      // å…œåº•æ¸…ç†ï¼šæ¸…ç†æ‰€æœ‰åŒ…å«ä¸šåŠ¡å…³é”®è¯çš„ key
      const keywordsToClean = [
        "supplier", "order", "contract", "delivery", "inbound", "outbound",
        "warehouse", "logistics", "product", "store", "account", "bill",
        "payment", "cash", "rebate", "commission", "employee", "notification",
        "adAgency", "adAccount", "adConsumption", "adRecharge", "influencer",
        "initialized", "Initialized", "mock", "Mock", "test", "Test", "clear", "Clear"
      ];
      
      const keysToKeep = ["sidebarCollapsed", "auth_token", "user_info"];
      
      try {
        const allKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key) allKeys.push(key);
        }
        
        allKeys.forEach(key => {
          if (keysToKeep.includes(key)) return;
          if (ALL_STORAGE_KEYS.includes(key)) return; // å·²ç»æ¸…ç†è¿‡äº†
          
          const shouldClean = keywordsToClean.some(keyword => 
            key.toLowerCase().includes(keyword.toLowerCase())
          );
          
          if (shouldClean) {
            try {
              localStorage.removeItem(key);
              clearedCount++;
            } catch (e) {
              console.error(`Failed to remove additional key: ${key}`, e);
              errorCount++;
            }
          }
        });
      } catch (e) {
        console.error("Failed to clean additional keys", e);
      }

      setTimeout(() => {
        if (errorCount > 0) {
          statusDiv.className = 'status error';
          statusDiv.textContent = `æ¸…ç©ºå®Œæˆï¼Œä½†æœ‰ ${errorCount} ä¸ªé”™è¯¯`;
        } else {
          statusDiv.className = 'status success';
          statusDiv.textContent = `âœ… å·²æˆåŠŸæ¸…ç©º ${clearedCount} æ¡æ•°æ®ï¼`;
        }
        
        clearBtn.disabled = false;
        updateStats();

        // 3ç§’åè·³è½¬åˆ°é¦–é¡µ
        setTimeout(() => {
          window.location.href = '/';
        }, 3000);
      }, 500);
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç»Ÿè®¡
    updateStats();
  </script>
</body>
</html>
