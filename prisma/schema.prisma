generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Platform {
  TIKTOK
  AMAZON
  INSTAGRAM
  YOUTUBE
  OTHER
}

// 旧的部门枚举（保留用于向后兼容，Employee 和 CommissionRule 仍使用）
enum DepartmentEnum {
  FINANCE
  PROCUREMENT
  LOGISTICS
  BD
  OPERATIONS
  EDITOR
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  PROBATION
}

enum CommissionRuleType {
  FIXED_AMOUNT
  PERCENTAGE
  TIERED
  CONDITIONAL
  FORMULA
}

enum CommissionPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
  PROJECT
}

enum InventoryMovementType {
  FACTORY_DONE
  FACTORY_SHIPMENT
  DOMESTIC_INBOUND
  DOMESTIC_OUTBOUND
  OCEAN_SHIPMENT
  OCEAN_ARRIVAL
  TRANSFER
  STOCKTAKE
  ADJUSTMENT
  SAMPLE_OUTBOUND
}

enum InventoryLocation {
  FACTORY
  DOMESTIC
  TRANSIT
  OVERSEAS
}

// 库存流水原因（入库/出库原因）
enum StockLogReason {
  // 入库原因
  PURCHASE_INBOUND // 采购入库
  RETURN_INBOUND // 退货入库
  TRANSFER_INBOUND // 调拨入库
  STOCKTAKE_ADJUSTMENT // 盘点调整（盘盈）
  PRODUCTION_COMPLETE // 生产完工入库
  SAMPLE_RETURN // 样品退回

  // 出库原因
  SALE_OUTBOUND // 销售出库
  TRANSFER_OUTBOUND // 调拨出库
  SAMPLE_OUTBOUND // 样品出库
  DAMAGE_WRITE_OFF // 损坏报废
  STOCKTAKE_LOSS // 盘点调整（盘亏）
  RETURN_SUPPLIER // 退供应商
}

enum LogisticsStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  EXCEPTION
}

enum PurchaseOrderStatus {
  PENDING_RISK
  RISK_APPROVED
  RISK_REJECTED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PUSHED_TO_PROCUREMENT
  CONTRACT_CREATED
  CANCELLED
}

enum PurchaseContractStatus {
  PENDING_SHIPMENT
  PARTIAL_SHIPMENT
  SHIPPED
  SETTLED
  CANCELLED
}

enum DeliveryOrderStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum VideoTaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum SupplierLevel {
  S
  A
  B
  C
}

enum SettleBase {
  SHIPMENT // 发货
  INBOUND // 入库
}

enum InvoiceRequirement {
  SPECIAL_INVOICE // 专票
  GENERAL_INVOICE // 普票
  NO_INVOICE // 不开票
}

enum ProductStatus {
  ACTIVE // 在售
  INACTIVE // 下架
}

enum AccountType {
  CORPORATE // 对公
  PERSONAL // 对私
  PLATFORM // 平台
}

enum AccountCategory {
  PRIMARY // 主账户
  VIRTUAL // 虚拟子账号
}

enum CashFlowType {
  INCOME // 收入
  EXPENSE // 支出
  TRANSFER // 划拨
}

enum CashFlowStatus {
  CONFIRMED // 已确认
  PENDING // 待核对
}

enum RiskControlStatus {
  PENDING // 待评估
  PASSED // 通过
  REJECTED // 拒绝
}

enum ApprovalStatus {
  PENDING // 待审批
  PASSED // 通过
  REJECTED // 拒绝
}

enum Urgency {
  NORMAL // 普通
  URGENT // 紧急
  CRITICAL // 加急
}

model Supplier {
  id                 String              @id @default(uuid())
  name               String
  contact            String
  phone              String
  depositRate        Decimal             @db.Decimal(5, 2)
  tailPeriodDays     Int
  settleBase         SettleBase
  level              SupplierLevel?
  category           String?
  address            String?
  bankAccount        String?
  bankName           String?
  taxId              String?
  invoiceRequirement InvoiceRequirement?
  invoicePoint       Decimal?            @db.Decimal(5, 2)
  defaultLeadTime    Int?
  moq                Int?
  factoryImages      Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  contracts        PurchaseContract[] @relation("SupplierToContract")
  productSuppliers ProductSupplier[]
  defaultProducts  Product[]          @relation("DefaultSupplier") // 作为默认供应商的产品
}

// Product (SPU - Standard Product Unit) - 产品
model Product {
  id          String        @id @default(uuid())
  name        String // 产品名称
  category    String? // 分类
  brand       String? // 品牌
  description String? // 产品描述
  mainImage   String? // 主图
  material    String? // 材质
  status      ProductStatus @default(ACTIVE) // 产品状态
  suppliers   Json? // 供应商信息（JSON）

  // 报关信息
  customsNameCN String? // 报关名（中文）
  customsNameEN String? // 报关名（英文）

  // 默认供应商（可选，也可以通过 ProductSupplier.isPrimary 获取）
  defaultSupplierId String? // 默认供应商 ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 一对多关系：一个 Product 可以有多个 ProductVariant
  variants ProductVariant[]

  // 关联关系
  videoTasks       VideoTask[]
  productSuppliers ProductSupplier[]

  // 默认供应商关联（可选）
  defaultSupplier Supplier? @relation("DefaultSupplier", fields: [defaultSupplierId], references: [id], onDelete: SetNull)

  @@index([defaultSupplierId])
}

// ProductVariant (SKU - Stock Keeping Unit) - 产品变体
model ProductVariant {
  id            String   @id @default(uuid())
  productId     String // 关联的 Product (SPU) ID
  skuId         String   @unique // SKU 编码（唯一标识）
  color         String? // 颜色
  size          String? // 尺寸
  weightKg      Decimal? @db.Decimal(10, 3) // 重量（千克）
  barcode       String? // 条形码
  costPrice     Decimal? @db.Decimal(18, 2) // 成本价
  stockQuantity Int      @default(0) // 库存数量（总库存）

  // 财务信息
  currency  String   @default("CNY") // 货币
  targetRoi Decimal? @db.Decimal(5, 2) // 目标 ROI

  // 物理尺寸（用于运费计算）
  lengthCm          Decimal? @db.Decimal(10, 2) // 长度（cm）
  widthCm           Decimal? @db.Decimal(10, 2) // 宽度（cm）
  heightCm          Decimal? @db.Decimal(10, 2) // 高度（cm）
  volumetricDivisor Int? // 体积重换算系数

  // 库存分布（轻量化实现）
  atFactory  Int @default(0) // 工厂现货数量
  atDomestic Int @default(0) // 国内待发数量
  inTransit  Int @default(0) // 海运中数量

  // 平台 SKU 映射
  platformSkuMapping Json? // 平台 SKU 映射（JSON）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  product        Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventories    InventoryStock[]
  movements      InventoryMovement[]
  stocks         Stock[] // 新库存表关联
  stockLogs      StockLog[] // 新库存流水表关联
  contractItems  PurchaseContractItem[]
  pendingInbound PendingInbound[] // 待入库单
  outboundOrders OutboundOrder[] // 出库单

  @@index([productId])
  @@index([skuId])
}

model Store {
  id          String   @id @default(uuid())
  name        String
  platform    Platform
  country     String
  currency    String
  accountId   String
  accountName String
  vatNumber   String?
  taxId       String?
  createdAt   DateTime @default(now())

  inventoryStocks InventoryStock[]
  logistics       LogisticsTracking[]
  bankAccounts    BankAccount[] // 关联的银行账户
  purchaseOrders  PurchaseOrder[] // 关联的采购订单
}

model Influencer {
  id                       String    @id @default(uuid())
  accountName              String
  platform                 Platform
  accountUrl               String?
  followerCount            Int
  contactInfo              String
  category                 String
  cooperationStatus        String
  sampleStatus             String
  sampleOrderNumber        String?
  sampleTrackingNumber     String?
  sampleProductSku         String?
  sampleProductId          String?
  sampleSentAt             DateTime?
  sampleReceivedAt         DateTime?
  historicalEngagementRate Decimal?  @db.Decimal(5, 2)
  estimatedOrders          Int?
  actualOrders             Int?
  notes                    String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  videoTasks VideoTask[]
}

// 部门模型
model Department {
  id          String   @id @default(uuid())
  name        String   @unique // 部门名称（唯一）
  code        String?  @unique // 部门编码（唯一，可选）
  description String? // 部门描述
  isActive    Boolean  @default(true) // 是否启用
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  users           User[] // 该部门的用户
  employees       Employee[] // 该部门的员工
  commissionRules CommissionRule[] // 该部门的提成规则
  purchaseOrders  PurchaseOrder[] // 流转到该部门的订单

  @@index([code])
  @@index([name])
}

// 用户模型
model User {
  id           String    @id @default(uuid())
  email        String    @unique // 邮箱（唯一）
  password     String // 密码（已哈希）
  name         String // 姓名
  role         String    @default("USER") // 角色：USER, ADMIN, SUPER_ADMIN
  departmentId String? // 关联的部门ID
  isActive     Boolean   @default(true) // 是否启用
  lastLoginAt  DateTime? // 最后登录时间
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // 关联关系
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([departmentId])
}

model Employee {
  id                     String           @id @default(uuid())
  name                   String
  employeeNumber         String?
  department             DepartmentEnum // 保留旧枚举（向后兼容）
  departmentId           String? // 关联到新的 Department 模型
  position               String
  joinDate               DateTime
  phone                  String?
  email                  String?
  status                 EmploymentStatus @default(ACTIVE)
  responsibleInfluencers String[]
  responsibleSuppliers   String[]
  responsibleStores      String[]
  notes                  String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  // 关联关系
  departmentRelation Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  commissionRecords  CommissionRecord[]
  videoTasks         VideoTask[]        @relation("Assignee")

  @@index([departmentId])
}

model CommissionRule {
  id           String             @id @default(uuid())
  name         String
  department   DepartmentEnum // 保留旧枚举（向后兼容）
  departmentId String? // 关联到新的 Department 模型
  position     String?
  type         CommissionRuleType
  config       Json
  dataSource   Json
  period       CommissionPeriod
  startDate    DateTime?
  endDate      DateTime?
  enabled      Boolean            @default(true)
  description  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // 关联关系
  departmentRelation Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  records            CommissionRecord[]

  @@index([departmentId])
}

model CommissionRecord {
  id          String   @id @default(uuid())
  employeeId  String
  ruleId      String
  periodLabel String
  amount      Decimal  @db.Decimal(18, 2)
  currency    String   @default("CNY")
  details     Json?
  generatedAt DateTime @default(now())

  employee Employee       @relation(fields: [employeeId], references: [id])
  rule     CommissionRule @relation(fields: [ruleId], references: [id])
}

// 仓库表（Warehouse）
model Warehouse {
  id        String            @id @default(uuid())
  code      String            @unique // 仓库编码（唯一标识）
  name      String // 仓库名称
  address   String? // 仓库地址
  contact   String? // 联系人
  phone     String? // 联系电话
  manager   String? // 仓库管理员
  location  InventoryLocation // 仓库位置类型（工厂/国内/在途/海外）
  isActive  Boolean           @default(true) // 是否启用
  capacity  Int? // 仓库容量（可选）
  notes     String? // 备注
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // 关联关系
  stocks          Stock[] // 该仓库的库存记录
  stockLogs       StockLog[] // 该仓库的库存流水
  inboundBatches  InboundBatch[] // 入库批次
  outboundOrders  OutboundOrder[] // 出库单
  outboundBatches OutboundBatch[] // 出库批次

  @@index([code])
  @@index([location])
}

// 库存表（Stock）- 记录 SKU 在每个仓库的数量
model Stock {
  id           String   @id @default(uuid())
  variantId    String // 关联到 ProductVariant (SKU)
  warehouseId  String // 关联到 Warehouse
  qty          Int      @default(0) // 库存数量
  reservedQty  Int      @default(0) // 预留数量（已分配但未出库）
  availableQty Int      @default(0) // 可用数量（qty - reservedQty，可计算字段）
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  // 关联关系
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  // 唯一约束：同一 SKU 在同一仓库只能有一条记录
  @@unique([variantId, warehouseId])
  @@index([variantId])
  @@index([warehouseId])
}

// 保留原有的 InventoryStock 模型以保持向后兼容（可选，如果不需要可以删除）
model InventoryStock {
  id        String            @id @default(uuid())
  variantId String // 关联到 ProductVariant (SKU)
  storeId   String?
  location  InventoryLocation
  qty       Int               @default(0)
  updatedAt DateTime          @updatedAt
  createdAt DateTime          @default(now())

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  store   Store?         @relation(fields: [storeId], references: [id])

  @@unique([variantId, location, storeId])
  @@index([variantId])
}

// 库存流水表（StockLog）- 记录入库出库原因
model StockLog {
  id                 String                @id @default(uuid())
  variantId          String // 关联到 ProductVariant (SKU)
  warehouseId        String // 关联到 Warehouse
  reason             StockLogReason // 入库/出库原因
  movementType       InventoryMovementType // 移动类型（保留原有枚举）
  qty                Int // 数量（正数表示入库，负数表示出库）
  qtyBefore          Int // 变动前数量
  qtyAfter           Int // 变动后数量
  unitCost           Decimal?              @db.Decimal(18, 2) // 单价
  totalCost          Decimal?              @db.Decimal(18, 2) // 总成本
  currency           String? // 货币
  operator           String? // 操作人
  operationDate      DateTime // 操作日期
  relatedOrderId     String? // 关联订单ID
  relatedOrderType   String? // 关联订单类型
  relatedOrderNumber String? // 关联订单号
  notes              String? // 备注
  createdAt          DateTime              @default(now())

  // 关联关系
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([warehouseId])
  @@index([reason])
  @@index([operationDate])
}

// 保留原有的 InventoryMovement 模型以保持向后兼容
model InventoryMovement {
  id                 String                @id @default(uuid())
  variantId          String // 关联到 ProductVariant (SKU)
  location           InventoryLocation
  movementType       InventoryMovementType
  qty                Int
  qtyBefore          Int
  qtyAfter           Int
  unitCost           Decimal?              @db.Decimal(18, 2)
  totalCost          Decimal?              @db.Decimal(18, 2)
  currency           String?
  relatedOrderId     String?
  relatedOrderType   String?
  relatedOrderNumber String?
  operator           String?
  operationDate      DateTime
  notes              String?
  createdAt          DateTime              @default(now())

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
}

model LogisticsChannel {
  id          String   @id @default(uuid())
  name        String
  channelCode String
  contact     String
  phone       String
  queryUrl    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trackings LogisticsTracking[]
}

model LogisticsTracking {
  id                  String          @id @default(uuid())
  internalOrderNumber String
  trackingNumber      String          @unique
  channelId           String
  storeId             String?
  currentStatus       LogisticsStatus
  shippedDate         DateTime
  lastUpdatedAt       DateTime
  transportDays       Int?
  orderId             String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  channel LogisticsChannel @relation(fields: [channelId], references: [id])
  store   Store?           @relation(fields: [storeId], references: [id])
  events  TrackingEvent[]
}

model TrackingEvent {
  id          String          @id @default(uuid())
  trackingId  String
  timestamp   DateTime
  location    String?
  description String
  status      LogisticsStatus

  tracking LogisticsTracking @relation(fields: [trackingId], references: [id])
}

model PurchaseContract {
  id                  String                 @id @default(uuid())
  contractNumber      String                 @unique
  supplierId          String?
  supplierName        String
  supplier            Supplier?              @relation("SupplierToContract", fields: [supplierId], references: [id], onDelete: SetNull)
  sku                 String
  skuId               String?
  unitPrice           Decimal                @db.Decimal(18, 2)
  totalQty            Int
  pickedQty           Int                    @default(0)
  finishedQty         Int                    @default(0)
  totalAmount         Decimal                @db.Decimal(18, 2)
  depositRate         Decimal                @db.Decimal(5, 2)
  depositAmount       Decimal                @db.Decimal(18, 2)
  depositPaid         Decimal                @default(0) @db.Decimal(18, 2)
  tailPeriodDays      Int
  deliveryDate        DateTime?
  status              PurchaseContractStatus
  contractVoucher     String?
  totalPaid           Decimal                @default(0) @db.Decimal(18, 2)
  totalOwed           Decimal                @default(0) @db.Decimal(18, 2)
  relatedOrderIds     String[]
  relatedOrderNumbers String[]
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  deliveryOrders DeliveryOrder[]
  orders         PurchaseOrder[] // 通过 contractId 关联的采购订单
  items          PurchaseContractItem[] // 合同明细（支持多 SKU）
}

model DeliveryOrder {
  id                     String              @id @default(uuid())
  deliveryNumber         String              @unique
  contractId             String
  contractNumber         String
  qty                    Int
  domesticTrackingNumber String?
  shippedDate            DateTime?
  status                 DeliveryOrderStatus
  tailAmount             Decimal             @db.Decimal(18, 2)
  tailPaid               Decimal             @default(0) @db.Decimal(18, 2)
  tailDueDate            DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  contract       PurchaseContract @relation(fields: [contractId], references: [id])
  pendingInbound PendingInbound? // 关联的待入库单（反向关联）
}

// 待入库单
model PendingInbound {
  id                     String    @id @default(uuid())
  inboundNumber          String    @unique // 入库单号
  deliveryOrderId        String    @unique // 关联的拿货单ID
  deliveryNumber         String // 拿货单号（冗余字段）
  contractId             String // 关联的合同ID
  contractNumber         String // 合同编号（冗余字段）
  sku                    String // SKU
  variantId              String? // 关联的产品SKU ID
  qty                    Int // 待入库数量
  receivedQty            Int       @default(0) // 已入库数量
  domesticTrackingNumber String? // 国内物流单号
  shippedDate            DateTime? // 发货日期
  status                 String    @default("待入库") // 状态：待入库、部分入库、已入库、已取消
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // 关联关系
  deliveryOrder DeliveryOrder   @relation(fields: [deliveryOrderId], references: [id], onDelete: Cascade)
  variant       ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  batches       InboundBatch[] // 入库批次

  @@index([deliveryOrderId])
  @@index([variantId])
  @@index([status])
}

// 入库批次
model InboundBatch {
  id               String   @id @default(uuid())
  pendingInboundId String // 关联的待入库单ID
  batchNumber      String // 批次号
  warehouseId      String // 入库仓库ID
  warehouseName    String // 入库仓库名称（冗余字段）
  qty              Int // 本次入库数量
  receivedDate     DateTime // 入库日期
  notes            String? // 备注
  createdAt        DateTime @default(now())

  // 关联关系
  pendingInbound PendingInbound @relation(fields: [pendingInboundId], references: [id], onDelete: Cascade)
  warehouse      Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([pendingInboundId])
  @@index([warehouseId])
}

// 出库单
model OutboundOrder {
  id             String   @id @default(uuid())
  outboundNumber String   @unique // 出库单号
  variantId      String // SKU ID
  sku            String // SKU名称（冗余字段）
  qty            Int // 出库数量
  shippedQty     Int      @default(0) // 已出库数量
  warehouseId    String // 出库仓库ID
  warehouseName  String // 出库仓库名称（冗余字段）
  destination    String? // 目的地
  status         String   @default("待出库") // 状态：待出库、部分出库、已出库、已取消
  reason         String? // 出库原因
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 关联关系
  variant   ProductVariant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  batches   OutboundBatch[] // 出库批次

  @@index([variantId])
  @@index([warehouseId])
  @@index([status])
}

// 出库批次
model OutboundBatch {
  id              String   @id @default(uuid())
  outboundOrderId String // 关联的出库单ID
  batchNumber     String // 批次号
  warehouseId     String // 出库仓库ID
  warehouseName   String // 出库仓库名称（冗余字段）
  qty             Int // 本次出库数量
  shippedDate     DateTime // 出库日期
  destination     String? // 目的地
  trackingNumber  String? // 物流单号
  notes           String? // 备注
  createdAt       DateTime @default(now())

  // 关联关系
  outboundOrder OutboundOrder @relation(fields: [outboundOrderId], references: [id], onDelete: Cascade)
  warehouse     Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([outboundOrderId])
  @@index([warehouseId])
}

model VideoTask {
  id           String          @id @default(uuid())
  title        String
  brief        String?
  productId    String?
  influencerId String?
  assigneeId   String?
  status       VideoTaskStatus @default(TODO)
  dueDate      DateTime?
  videoUrl     String?
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  product    Product?    @relation(fields: [productId], references: [id])
  influencer Influencer? @relation(fields: [influencerId], references: [id])
  assignee   Employee?   @relation("Assignee", fields: [assigneeId], references: [id])
}

model BankAccount {
  id               String          @id @default(uuid())
  name             String
  accountNumber    String
  accountType      AccountType
  accountCategory  AccountCategory
  accountPurpose   String
  currency         String          @default("RMB")
  country          String          @default("CN")
  originalBalance  Decimal         @default(0) @db.Decimal(18, 2) // 当前原币余额（会随流水变化）
  initialCapital   Decimal         @default(0) @db.Decimal(18, 2) // 原始资金（账户初始资金，固定值）
  exchangeRate     Decimal         @default(1) @db.Decimal(10, 4)
  rmbBalance       Decimal         @default(0) @db.Decimal(18, 2) // 计算字段，可冗余存储
  parentId         String? // 父账户ID（虚拟子账号关联主账户）
  storeId          String? // 关联店铺ID
  companyEntity    String?
  owner            String? // 账号归属人
  notes            String          @default("")
  platformAccount  String?
  platformPassword String?
  platformUrl      String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // 自关联：主账户 -> 虚拟子账号
  parent   BankAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children BankAccount[] @relation("AccountHierarchy")

  // 关联店铺
  store Store? @relation(fields: [storeId], references: [id], onDelete: SetNull)

  // 关联流水
  cashFlows CashFlow[]
}

model CashFlow {
  id             String         @id @default(uuid())
  uid            String?        @unique // 全局唯一业务ID（业财一体化）
  date           DateTime
  summary        String
  category       String // 分类：采购/物流/回款/划拨/手续费等（支持一级/二级）
  type           CashFlowType
  amount         Decimal        @db.Decimal(18, 2)
  accountId      String
  accountName    String // 冗余字段，便于查询
  currency       String         @default("CNY")
  remark         String         @default("")
  relatedId      String? // 关联的采购单ID等
  businessNumber String? // 关联业务单号（如采购单号）
  status         CashFlowStatus @default(CONFIRMED)
  isReversal     Boolean        @default(false)
  reversedById   String? // 被冲销的记录ID
  voucher        String? // 凭证（图片 base64 或 URL，建议存 URL）
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // 关联账户
  account BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // 自关联：冲销关系
  reversedBy CashFlow?  @relation("Reversal", fields: [reversedById], references: [id], onDelete: SetNull)
  reversals  CashFlow[] @relation("Reversal")
}

model PurchaseOrder {
  id          String  @id @default(uuid())
  orderNumber String  @unique
  uid         String? @unique // 全局唯一业务ID

  // 下单信息（运营填写）
  createdBy            String
  platform             Platform
  storeId              String?
  storeName            String?
  sku                  String
  skuId                String?
  productName          String?
  quantity             Int
  expectedDeliveryDate DateTime?
  urgency              String    @default("普通")
  notes                String?

  // 风控评估
  riskControlStatus   String    @default("待评估")
  riskControlBy       String?
  riskControlAt       DateTime?
  riskControlNotes    String?
  riskControlSnapshot Json? // 风控时的库存快照

  // 审批流程
  approvalStatus String    @default("待审批")
  approvedBy     String?
  approvedAt     DateTime?
  approvalNotes  String?

  // 采购关联
  pushedToProcurementAt DateTime?
  pushedBy              String?
  procurementNotes      String?

  // 合同关联（采购完成后）
  contractId String?           @unique
  contract   PurchaseContract? @relation(fields: [contractId], references: [id])

  // 订单流转（标记现在流转到了哪个部门）
  currentStep String? // 当前流转到的部门ID（关联到 Department）

  // 状态
  status    PurchaseOrderStatus @default(PENDING_RISK)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // 关联关系
  store           Store?      @relation(fields: [storeId], references: [id], onDelete: SetNull)
  currentStepDept Department? @relation(fields: [currentStep], references: [id], onDelete: SetNull)

  @@index([currentStep])
}

// 产品-供应商关联表（多对多关系）
model ProductSupplier {
  id         String   @id @default(uuid())
  productId  String
  supplierId String
  price      Decimal? @db.Decimal(18, 2) // 供应商对该产品的报价
  moq        Int? // 最小起订量
  leadTime   Int? // 交期（天）
  isPrimary  Boolean  @default(false) // 是否为主供应商
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@index([productId])
  @@index([supplierId])
}

// 采购合同明细表（支持一个合同多个 SKU）
model PurchaseContractItem {
  id          String   @id @default(uuid())
  contractId  String
  variantId   String? // 产品变体 (SKU) ID
  sku         String // SKU 编码（冗余字段）
  unitPrice   Decimal  @db.Decimal(18, 2)
  qty         Int
  pickedQty   Int      @default(0) // 已取货数
  finishedQty Int      @default(0) // 工厂完工数
  totalAmount Decimal  @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contract PurchaseContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  variant  ProductVariant?  @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([contractId, variantId])
  @@index([contractId])
  @@index([variantId])
}
