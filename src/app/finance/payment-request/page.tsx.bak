"use client";

import React, { useState, useEffect, useMemo } from "react";
import { getPaymentRequests, savePaymentRequests, getPaymentRequestsByStatus, type PaymentRequest } from "@/lib/payment-request-store";
import { type BillStatus } from "@/lib/reconciliation-store";
import { getStores, type Store } from "@/lib/store-store";
import { getAccounts, saveAccounts, type BankAccount } from "@/lib/finance-store";
import { formatCurrency } from "@/lib/currency-utils";
import { COUNTRIES } from "@/lib/country-config";
import ImageUploader from "@/components/ImageUploader";
import { FileText, Filter, Plus, Edit, Send, CheckCircle, XCircle, Clock, DollarSign } from "lucide-react";

export default function PaymentRequestPage() {
  const [requests, setRequests] = useState<PaymentRequest[]>([]);
  const [stores, setStores] = useState<Store[]>([]);
  const [accounts, setAccounts] = useState<BankAccount[]>([]);
  const [filterStatus, setFilterStatus] = useState<BillStatus | "all">("all");
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
  const [selectedRequest, setSelectedRequest] = useState<PaymentRequest | null>(null);
  const [editingRequest, setEditingRequest] = useState<PaymentRequest | null>(null);
  const [rejectModal, setRejectModal] = useState<{ open: boolean; id: string | null }>({
    open: false,
    id: null
  });
  const [rejectReason, setRejectReason] = useState("");
  
  // 模拟用户角色（实际应该从用户系统获取）
  const [userRole] = useState<"finance" | "boss" | "cashier">("finance");

  const [form, setForm] = useState({
    expenseItem: "",
    amount: "",
    currency: "CNY" as "USD" | "CNY" | "HKD",
    storeId: "",
    country: "",
    category: "其他",
    notes: "",
    approvalDocument: "" as string | string[] // Base64图片，支持多图
  });
  const [paymentReceipt, setPaymentReceipt] = useState<string | string[]>(""); // 转账截图，支持多图

  useEffect(() => {
    if (typeof window === "undefined") return;
    const loadedRequests = getPaymentRequests();
    setRequests(loadedRequests);
    const loadedStores = getStores();
    setStores(loadedStores);
    const loadedAccounts = getAccounts();
    setAccounts(loadedAccounts);
  }, []);

  const filteredRequests = useMemo(() => {
    if (filterStatus === "all") return requests;
    return requests.filter((r) => r.status === filterStatus);
  }, [requests, filterStatus]);

  // 统计数据
  const stats = useMemo(() => {
    const total = requests.length;
    const draft = requests.filter((r) => r.status === "Draft").length;
    const pending = requests.filter((r) => r.status === "Pending_Approval").length;
    const approved = requests.filter((r) => r.status === "Approved").length;
    const paid = requests.filter((r) => r.status === "Paid").length;
    const totalAmount = requests
      .filter((r) => r.status === "Paid")
      .reduce((sum, r) => {
        // 简单计算，实际应该考虑汇率
        return sum + r.amount;
      }, 0);

    return { total, draft, pending, approved, paid, totalAmount };
  }, [requests]);

  const handleCreate = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    if (!form.expenseItem.trim()) {
      alert("请填写支出项目");
      return;
    }
    
    const amount = Number(form.amount);
    if (Number.isNaN(amount) || amount <= 0) {
      alert("请填写有效的金额");
      return;
    }
    
    // 检查审批凭证（支持单图或多图）
    const approvalDoc = Array.isArray(form.approvalDocument) 
      ? (form.approvalDocument.length > 0 ? form.approvalDocument : null)
      : (form.approvalDocument || null);
    
    if (!approvalDoc) {
      alert("请上传老板签字申请单");
      return;
    }
    
    const store = form.storeId ? stores.find((s) => s.id === form.storeId) : null;
    
    const newRequest: PaymentRequest = {
      id: "payment-request-" + Date.now() + "-" + Math.random().toString(36).slice(2, 9),
      expenseItem: form.expenseItem.trim(),
      amount,
      currency: form.currency,
      storeId: form.storeId || undefined,
      storeName: store?.name,
      country: form.country || undefined,
      category: form.category,
      notes: form.notes.trim() || undefined,
      approvalDocument: approvalDoc,
      status: "Pending_Approval", // 直接提交审批
      createdBy: "财务人员", // 实际应该从用户系统获取
      createdAt: new Date().toISOString(),
      submittedAt: new Date().toISOString()
    };
    
    const updated = [...requests, newRequest];
    setRequests(updated);
    savePaymentRequests(updated);
    
    alert("✅ 付款申请已提交审批");
    
    // 重置表单
    setForm({
      expenseItem: "",
      amount: "",
      currency: "CNY",
      storeId: "",
      country: "",
      category: "其他",
      notes: "",
      approvalDocument: ""
    });
    setIsCreateModalOpen(false);
  };

  const handleUpdate = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    if (!editingRequest) return;
    
    if (!form.expenseItem.trim()) {
      alert("请填写支出项目");
      return;
    }
    
    const amount = Number(form.amount);
    if (Number.isNaN(amount) || amount <= 0) {
      alert("请填写有效的金额");
      return;
    }
    
    // 检查审批凭证（支持单图或多图）
    const approvalDoc = Array.isArray(form.approvalDocument) 
      ? (form.approvalDocument.length > 0 ? form.approvalDocument : null)
      : (form.approvalDocument || null);
    
    if (!approvalDoc) {
      alert("请上传老板签字申请单");
      return;
    }
    
    const store = form.storeId ? stores.find((s) => s.id === form.storeId) : null;
    
    const updated = requests.map((r) =>
      r.id === editingRequest.id
        ? {
            ...r,
            expenseItem: form.expenseItem.trim(),
            amount,
            currency: form.currency,
            storeId: form.storeId || undefined,
            storeName: store?.name,
            country: form.country || undefined,
            category: form.category,
            notes: form.notes.trim() || undefined,
            approvalDocument: approvalDoc,
            rejectionReason: undefined // 清除退回原因
          }
        : r
    );
    
    setRequests(updated);
    savePaymentRequests(updated);
    
    alert("✅ 付款申请已更新");
    
    // 重置表单和状态
    setForm({
      expenseItem: "",
      amount: "",
      currency: "CNY",
      storeId: "",
      country: "",
      category: "其他",
      notes: "",
      approvalDocument: ""
    });
    setEditingRequest(null);
    setIsEditModalOpen(false);
  };

  const handleApprove = (id: string) => {
    if (!confirm("确定要批准这笔付款申请吗？")) return;
    
    const updated = requests.map((r) =>
      r.id === id
        ? {
            ...r,
            status: "Approved" as BillStatus,
            approvedBy: "老板",
            approvedAt: new Date().toISOString()
          }
        : r
    );
    setRequests(updated);
    savePaymentRequests(updated);
    alert("✅ 已批准");
  };

  const handleReject = (id: string) => {
    setRejectModal({ open: true, id });
  };

  const handleConfirmReject = () => {
    if (!rejectModal.id) return;
    if (!rejectReason.trim()) {
      alert("请输入退回原因");
      return;
    }
    
    const updated = requests.map((r) =>
      r.id === rejectModal.id
        ? {
            ...r,
            status: "Draft" as BillStatus,
            rejectionReason: rejectReason.trim()
          }
        : r
    );
    setRequests(updated);
    savePaymentRequests(updated);
    alert("✅ 已退回修改");
    setRejectModal({ open: false, id: null });
    setRejectReason("");
  };

  const handlePay = (request: PaymentRequest) => {
    if (!request.paymentReceipt) {
      alert("请先上传转账截图");
      return;
    }
    if (!request.paymentAccountId) {
      alert("请选择出款账户");
      return;
    }
    
    if (!confirm("确定要确认支付吗？系统将自动更新财务流水和账户余额。")) return;
    
    const account = accounts.find((a) => a.id === request.paymentAccountId);
    if (!account) {
      alert("出款账户不存在");
      return;
    }
    
    // 创建财务流水
    const CASH_FLOW_KEY = "cashFlow";
    if (typeof window !== "undefined") {
      try {
        const storedFlow = window.localStorage.getItem(CASH_FLOW_KEY);
        const cashFlow: Array<{
          id: string;
          date: string;
          summary: string;
          category: string;
          type: "income" | "expense";
          amount: number;
          accountId: string;
          accountName: string;
          currency: string;
          remark: string;
          relatedId?: string;
          status: string;
          createdAt: string;
        }> = storedFlow ? JSON.parse(storedFlow) : [];
        
        const newFlow = {
          id: "flow-" + Date.now() + "-" + Math.random().toString(36).slice(2, 9),
          date: new Date().toISOString().slice(0, 10),
          summary: "付款申请-" + request.expenseItem,
          category: request.category,
          type: "expense" as const,
          amount: -request.amount, // 支出为负数
          accountId: request.paymentAccountId!,
          accountName: account.name,
          currency: request.currency,
          remark: "付款申请：" + request.expenseItem + (request.storeName ? " | 店铺：" + request.storeName : "") + (request.notes ? " | 备注：" + request.notes : ""),
          relatedId: request.id,
          status: "confirmed",
          createdAt: new Date().toISOString()
        };
        
        cashFlow.push(newFlow);
        window.localStorage.setItem(CASH_FLOW_KEY, JSON.stringify(cashFlow));
        
        // 更新账户余额
        const updatedAccounts = accounts.map((acc) =>
          acc.id === request.paymentAccountId
            ? {
                ...acc,
                originalBalance: acc.originalBalance - request.amount,
                rmbBalance: acc.rmbBalance - request.amount
              }
            : acc
        );
        saveAccounts(updatedAccounts);
        setAccounts(updatedAccounts);
        
        // 更新付款申请状态
        const updated = requests.map((r) =>
          r.id === request.id
            ? {
                ...r,
                status: "Paid" as BillStatus,
                paidBy: "出纳",
                paidAt: new Date().toISOString(),
                paymentFlowId: newFlow.id
              }
            : r
        );
        setRequests(updated);
        savePaymentRequests(updated);
        
        alert("✅ 支付确认成功！财务流水和账户余额已更新");
        setIsPaymentModalOpen(false);
        setSelectedRequest(null);
      } catch (e) {
        console.error("Failed to create cash flow", e);
        alert("创建财务流水失败：" + (e as Error).message);
      }
    }
  };

  const statusColors: Record<BillStatus, string> = {
    Draft: "bg-slate-500/20 text-slate-300 border-slate-500/40",
    Pending_Approval: "bg-amber-500/20 text-amber-300 border-amber-500/40",
    Approved: "bg-emerald-500/20 text-emerald-300 border-emerald-500/40",
    Paid: "bg-blue-500/20 text-blue-300 border-blue-500/40"
  };

  const statusLabels: Record<BillStatus, string> = {
    Draft: "草稿",
    Pending_Approval: "待审批",
    Approved: "已核准",
    Paid: "已支付"
  };

  const expenseCategories: string[] = [
    "办公用品",
    "差旅费",
    "房租水电",
    "员工福利",
    "营销推广",
    "技术服务",
    "其他"
  ];

  return (
    <div className="p-6 space-y-6">
      {/* 页面标题和操作栏 */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg bg-primary-500/10 border border-primary-500/30">
            <FileText className="w-6 h-6 text-primary-400" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-slate-100">通用付款申请</h1>
            <p className="text-sm text-slate-400 mt-0.5">管理所有非账单类支出申请</p>
          </div>
        </div>
        <div className="flex gap-2">
          {userRole === "finance" && (
            <button
              onClick={() => setIsCreateModalOpen(true)}
              className="flex items-center gap-2 rounded-lg bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 transition shadow-lg shadow-primary-500/20"
            >
              <Plus className="w-4 h-4" />
              发起付款
            </button>
          )}
          <div className="relative">
            <Filter className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" />
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value as BillStatus | "all")}
              className="pl-9 pr-4 py-2 rounded-lg border border-slate-700 bg-slate-900 text-sm text-slate-100 outline-none focus:border-primary-400 focus:ring-1 focus:ring-primary-400 appearance-none cursor-pointer"
            >
              <option value="all">全部状态</option>
              <option value="Draft">草稿</option>
              <option value="Pending_Approval">待审批</option>
              <option value="Approved">已核准</option>
              <option value="Paid">已支付</option>
            </select>
          </div>
        </div>
      </div>

      {/* 统计卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div className="rounded-xl border border-slate-800 bg-slate-900/60 p-4 hover:bg-slate-900/80 transition">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-slate-400 mb-1">总申请数</p>
              <p className="text-2xl font-bold text-slate-100">{stats.total}</p>
            </div>
            <div className="p-2 rounded-lg bg-slate-800">
              <FileText className="w-5 h-5 text-slate-400" />
            </div>
          </div>
        </div>
        <div className="rounded-xl border border-slate-800 bg-slate-900/60 p-4 hover:bg-slate-900/80 transition">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-slate-400 mb-1">草稿</p>
              <p className="text-2xl font-bold text-slate-300">{stats.draft}</p>
            </div>
            <div className="p-2 rounded-lg bg-slate-500/20">
              <Edit className="w-5 h-5 text-slate-400" />
            </div>
          </div>
        </div>
        <div className="rounded-xl border border-amber-500/30 bg-amber-500/5 p-4 hover:bg-amber-500/10 transition">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-amber-400 mb-1">待审批</p>
              <p className="text-2xl font-bold text-amber-300">{stats.pending}</p>
            </div>
            <div className="p-2 rounded-lg bg-amber-500/20">
              <Clock className="w-5 h-5 text-amber-400" />
            </div>
          </div>
        </div>
        <div className="rounded-xl border border-emerald-500/30 bg-emerald-500/5 p-4 hover:bg-emerald-500/10 transition">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-emerald-400 mb-1">已核准</p>
              <p className="text-2xl font-bold text-emerald-300">{stats.approved}</p>
            </div>
            <div className="p-2 rounded-lg bg-emerald-500/20">
              <CheckCircle className="w-5 h-5 text-emerald-400" />
            </div>
          </div>
        </div>
        <div className="rounded-xl border border-blue-500/30 bg-blue-500/5 p-4 hover:bg-blue-500/10 transition">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-blue-400 mb-1">已支付</p>
              <p className="text-2xl font-bold text-blue-300">{stats.paid}</p>
            </div>
            <div className="p-2 rounded-lg bg-blue-500/20">
              <DollarSign className="w-5 h-5 text-blue-400" />
            </div>
          </div>
        </div>
      </div>

      {/* 申请列表 */}
      {filteredRequests.length === 0 ? (
        <div className="rounded-xl border border-slate-800 bg-slate-900/60 p-12 text-center">
          <div className="inline-flex p-4 rounded-full bg-slate-800 mb-4">
            <FileText className="w-8 h-8 text-slate-500" />
          </div>
          <p className="text-slate-400 text-lg font-medium mb-2">暂无付款申请记录</p>
          <p className="text-slate-500 text-sm">
            {filterStatus === "all" 
              ? "点击上方"发起付款"按钮创建新的付款申请" 
              : `当前筛选条件下暂无${statusLabels[filterStatus as BillStatus] || ""}状态的申请`}
          </p>
        </div>
      ) : (
        <div className="rounded-xl border border-slate-800 bg-slate-900/60 overflow-hidden shadow-lg">
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-slate-800/80 border-b border-slate-700">
                <tr>
                  <th className="px-6 py-4 text-left font-semibold text-slate-300">支出项目</th>
                  <th className="px-6 py-4 text-right font-semibold text-slate-300">金额</th>
                  <th className="px-6 py-4 text-left font-semibold text-slate-300">分类</th>
                  <th className="px-6 py-4 text-left font-semibold text-slate-300">店铺/国家</th>
                  <th className="px-6 py-4 text-center font-semibold text-slate-300">状态</th>
                  <th className="px-6 py-4 text-left font-semibold text-slate-300">创建时间</th>
                  <th className="px-6 py-4 text-right font-semibold text-slate-300">操作</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-800/50">
                {filteredRequests.map((request) => (
                  <tr key={request.id} className="hover:bg-slate-800/30 transition-colors">
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 rounded-full bg-primary-500/50"></div>
                        <span className="text-slate-100 font-medium">{request.expenseItem}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="font-semibold">
                        {formatCurrency(request.amount, request.currency, "expense")}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className="px-2 py-1 rounded-md bg-slate-800 text-slate-300 text-xs">
                        {request.category}
                      </span>
                    </td>
                    <td className="px-6 py-4">
                      <span className="text-slate-300 text-xs">
                        {request.storeName || request.country || (
                          <span className="text-slate-500">未指定</span>
                        )}
                      </span>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex flex-col items-center gap-2">
                        <span className={`px-3 py-1.5 rounded-lg text-xs font-medium border ${statusColors[request.status]}`}>
                          {statusLabels[request.status]}
                        </span>
                        {request.rejectionReason && (
                          <div 
                            className="text-xs text-rose-400 max-w-xs truncate cursor-help" 
                            title={request.rejectionReason}
                          >
                            <XCircle className="w-3 h-3 inline mr-1" />
                            退回：{request.rejectionReason}
                          </div>
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="text-xs text-slate-400">
                        <div>{new Date(request.createdAt).toLocaleDateString("zh-CN")}</div>
                        <div className="text-slate-500 mt-0.5">{request.createdBy}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex gap-2 justify-end">
                      {request.status === "Draft" && userRole === "finance" && (
                        <>
                          <button
                            onClick={() => {
                              setEditingRequest(request);
                              setForm({
                                expenseItem: request.expenseItem,
                                amount: request.amount.toString(),
                                currency: request.currency,
                                storeId: request.storeId || "",
                                country: request.country || "",
                                category: request.category,
                                notes: request.notes || "",
                                approvalDocument: request.approvalDocument
                              });
                              setIsEditModalOpen(true);
                            }}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-primary-500/40 bg-primary-500/10 text-xs text-primary-100 hover:bg-primary-500/20 transition"
                          >
                            <Edit className="w-3.5 h-3.5" />
                            编辑
                          </button>
                          <button
                            onClick={() => {
                              const hasDoc = Array.isArray(request.approvalDocument)
                                ? request.approvalDocument.length > 0
                                : !!request.approvalDocument;
                              if (!hasDoc) {
                                alert("请先上传老板签字申请单");
                                return;
                              }
                              const updated = requests.map((r) =>
                                r.id === request.id
                                  ? {
                                      ...r,
                                      status: "Pending_Approval" as BillStatus,
                                      submittedAt: new Date().toISOString(),
                                      rejectionReason: undefined // 清除退回原因
                                    }
                                  : r
                              );
                              setRequests(updated);
                              savePaymentRequests(updated);
                              alert("✅ 付款申请已重新提交审批");
                            }}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-emerald-500/40 bg-emerald-500/10 text-xs text-emerald-100 hover:bg-emerald-500/20 transition"
                          >
                            <Send className="w-3.5 h-3.5" />
                            提交
                          </button>
                        </>
                      )}
                      {request.status === "Pending_Approval" && userRole === "boss" && (
                        <>
                          <button
                            onClick={() => handleApprove(request.id)}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-emerald-500/40 bg-emerald-500/10 text-xs text-emerald-100 hover:bg-emerald-500/20 transition"
                          >
                            <CheckCircle className="w-3.5 h-3.5" />
                            批准
                          </button>
                          <button
                            onClick={() => handleReject(request.id)}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-rose-500/40 bg-rose-500/10 text-xs text-rose-100 hover:bg-rose-500/20 transition"
                          >
                            <XCircle className="w-3.5 h-3.5" />
                            退回
                          </button>
                        </>
                      )}
                      {request.status === "Approved" && userRole === "cashier" && (
                        <button
                          onClick={() => {
                            setSelectedRequest(request);
                            setIsPaymentModalOpen(true);
                          }}
                          className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-blue-500/40 bg-blue-500/10 text-xs text-blue-100 hover:bg-blue-500/20 transition"
                        >
                          <DollarSign className="w-3.5 h-3.5" />
                          核销
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* 创建付款申请弹窗 */}
      {isCreateModalOpen && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
          <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold">发起付款申请</h2>
              <button
                onClick={() => setIsCreateModalOpen(false)}
                className="text-slate-400 hover:text-slate-200"
              >
                ✕
              </button>
            </div>
            <form onSubmit={handleCreate} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">支出项目 *</label>
                <input
                  type="text"
                  value={form.expenseItem}
                  onChange={(e) => setForm((f) => ({ ...f, expenseItem: e.target.value }))}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  placeholder="例如：办公室租金"
                  required
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">金额 *</label>
                  <input
                    type="number"
                    step="0.01"
                    min="0.01"
                    value={form.amount}
                    onChange={(e) => setForm((f) => ({ ...f, amount: e.target.value }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">币种 *</label>
                  <select
                    value={form.currency}
                    onChange={(e) => setForm((f) => ({ ...f, currency: e.target.value as "USD" | "CNY" | "HKD" }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                    required
                  >
                    <option value="USD">USD</option>
                    <option value="CNY">CNY</option>
                    <option value="HKD">HKD</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">支出分类 *</label>
                <select
                  value={form.category}
                  onChange={(e) => setForm((f) => ({ ...f, category: e.target.value }))}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  required
                >
                  {expenseCategories.map((cat) => (
                    <option key={cat} value={cat}>
                      {cat}
                    </option>
                  ))}
                </select>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">所属店铺（可选）</label>
                  <select
                    value={form.storeId}
                    onChange={(e) => {
                      const store = stores.find((s) => s.id === e.target.value);
                      setForm((f) => ({
                        ...f,
                        storeId: e.target.value,
                        country: store?.country || ""
                      }));
                    }}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  >
                    <option value="">不关联店铺</option>
                    {stores.map((store) => (
                      <option key={store.id} value={store.id}>
                        {store.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">所属国家（可选）</label>
                  <select
                    value={form.country}
                    onChange={(e) => setForm((f) => ({ ...f, country: e.target.value }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  >
                    <option value="">不指定国家</option>
                    {COUNTRIES.filter((c) => c.code !== "GLOBAL").map((country) => (
                      <option key={country.code} value={country.code}>
                        {country.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">备注</label>
                <textarea
                  value={form.notes}
                  onChange={(e) => setForm((f) => ({ ...f, notes: e.target.value }))}
                  rows={3}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  placeholder="可选备注信息"
                />
              </div>

              <ImageUploader
                value={form.approvalDocument}
                onChange={(value) => setForm((f) => ({ ...f, approvalDocument: value as string | string[] }))}
                multiple={true}
                label="老板签字申请单"
                required={true}
                placeholder="点击上传或直接 Ctrl + V 粘贴图片（支持多图）"
                maxImages={5}
                onError={(error) => alert(error)}
              />

              <div className="flex gap-3 justify-end pt-2">
                <button
                  type="button"
                  onClick={() => setIsCreateModalOpen(false)}
                  className="px-4 py-2 rounded-md border border-slate-700 text-slate-300 hover:bg-slate-800"
                >
                  取消
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-primary-500 text-white hover:bg-primary-600"
                >
                  提交审批
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* 编辑付款申请弹窗 */}
      {isEditModalOpen && editingRequest && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
          <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold">编辑付款申请</h2>
              <button
                onClick={() => {
                  setIsEditModalOpen(false);
                  setEditingRequest(null);
                  setForm({
                    expenseItem: "",
                    amount: "",
                    currency: "CNY",
                    storeId: "",
                    country: "",
                    category: "其他",
                    notes: "",
                    approvalDocument: ""
                  });
                }}
                className="text-slate-400 hover:text-slate-200"
              >
                ✕
              </button>
            </div>
            {editingRequest.rejectionReason && (
              <div className="mb-4 p-3 rounded-md bg-rose-500/10 border border-rose-500/40">
                <div className="text-xs text-rose-400 mb-1">退回原因：</div>
                <div className="text-sm text-rose-300">{editingRequest.rejectionReason}</div>
              </div>
            )}
            <form onSubmit={handleUpdate} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">支出项目 *</label>
                <input
                  type="text"
                  value={form.expenseItem}
                  onChange={(e) => setForm((f) => ({ ...f, expenseItem: e.target.value }))}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  placeholder="例如：办公室租金"
                  required
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">金额 *</label>
                  <input
                    type="number"
                    step="0.01"
                    min="0.01"
                    value={form.amount}
                    onChange={(e) => setForm((f) => ({ ...f, amount: e.target.value }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">币种 *</label>
                  <select
                    value={form.currency}
                    onChange={(e) => setForm((f) => ({ ...f, currency: e.target.value as "USD" | "CNY" | "HKD" }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                    required
                  >
                    <option value="USD">USD</option>
                    <option value="CNY">CNY</option>
                    <option value="HKD">HKD</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">支出分类 *</label>
                <select
                  value={form.category}
                  onChange={(e) => setForm((f) => ({ ...f, category: e.target.value }))}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  required
                >
                  {expenseCategories.map((cat) => (
                    <option key={cat} value={cat}>
                      {cat}
                    </option>
                  ))}
                </select>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">所属店铺（可选）</label>
                  <select
                    value={form.storeId}
                    onChange={(e) => {
                      const store = stores.find((s) => s.id === e.target.value);
                      setForm((f) => ({
                        ...f,
                        storeId: e.target.value,
                        country: store?.country || ""
                      }));
                    }}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  >
                    <option value="">不关联店铺</option>
                    {stores.map((store) => (
                      <option key={store.id} value={store.id}>
                        {store.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-1">所属国家（可选）</label>
                  <select
                    value={form.country}
                    onChange={(e) => setForm((f) => ({ ...f, country: e.target.value }))}
                    className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  >
                    <option value="">不指定国家</option>
                    {COUNTRIES.filter((c) => c.code !== "GLOBAL").map((country) => (
                      <option key={country.code} value={country.code}>
                        {country.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">备注</label>
                <textarea
                  value={form.notes}
                  onChange={(e) => setForm((f) => ({ ...f, notes: e.target.value }))}
                  rows={3}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  placeholder="可选备注信息"
                />
              </div>

              <ImageUploader
                value={form.approvalDocument}
                onChange={(value) => setForm((f) => ({ ...f, approvalDocument: value as string | string[] }))}
                multiple={true}
                label="老板签字申请单"
                required={true}
                placeholder="点击上传或直接 Ctrl + V 粘贴图片（支持多图）"
                maxImages={5}
                onError={(error) => alert(error)}
              />

              <div className="flex gap-3 justify-end pt-2">
                <button
                  type="button"
                  onClick={() => {
                    setIsEditModalOpen(false);
                    setEditingRequest(null);
                    setForm({
                      expenseItem: "",
                      amount: "",
                      currency: "CNY",
                      storeId: "",
                      country: "",
                      category: "其他",
                      notes: "",
                      approvalDocument: ""
                    });
                  }}
                  className="px-4 py-2 rounded-md border border-slate-700 text-slate-300 hover:bg-slate-800"
                >
                  取消
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-primary-500 text-white hover:bg-primary-600"
                >
                  保存修改
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* 核销弹窗 */}
      {isPaymentModalOpen && selectedRequest && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
          <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-2xl">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold">核销付款申请</h2>
              <button
                onClick={() => {
                  setIsPaymentModalOpen(false);
                  setSelectedRequest(null);
                }}
                className="text-slate-400 hover:text-slate-200"
              >
                ✕
              </button>
            </div>
            
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-xs text-slate-400 mb-1">支出项目</div>
                  <div className="text-slate-100">{selectedRequest.expenseItem}</div>
                </div>
                <div>
                  <div className="text-xs text-slate-400 mb-1">金额</div>
                  <div className="text-slate-100">
                    {formatCurrency(selectedRequest.amount, selectedRequest.currency, "expense")}
                  </div>
                </div>
              </div>

              <ImageUploader
                value={selectedRequest.paymentReceipt || paymentReceipt}
                onChange={(value) => {
                  const receipt = value as string | string[];
                  setPaymentReceipt(receipt);
                  // 更新付款申请的回单
                  const updated = requests.map((r) =>
                    r.id === selectedRequest.id ? { ...r, paymentReceipt: receipt } : r
                  );
                  setRequests(updated);
                  savePaymentRequests(updated);
                  setSelectedRequest(updated.find((r) => r.id === selectedRequest.id)!);
                }}
                multiple={true}
                label="转账截图"
                required={true}
                placeholder="点击上传或直接 Ctrl + V 粘贴图片（支持多图）"
                maxImages={5}
                onError={(error) => alert(error)}
              />

              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">出款账户 *</label>
                <select
                  value={selectedRequest.paymentAccountId || ""}
                  onChange={(e) => {
                    const account = accounts.find((a) => a.id === e.target.value);
                    const updated = requests.map((r) =>
                      r.id === selectedRequest.id
                        ? {
                            ...r,
                            paymentAccountId: e.target.value,
                            paymentAccountName: account?.name
                          }
                        : r
                    );
                    setRequests(updated);
                    savePaymentRequests(updated);
                    setSelectedRequest(updated.find((r) => r.id === selectedRequest.id)!);
                  }}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  required
                >
                  <option value="">请选择出款账户</option>
                  {accounts.map((account) => (
                    <option key={account.id} value={account.id}>
                      {account.name} ({account.currency})
                    </option>
                  ))}
                </select>
              </div>

              <div className="flex gap-3 justify-end pt-2">
                <button
                  type="button"
                  onClick={() => {
                    setIsPaymentModalOpen(false);
                    setSelectedRequest(null);
                  }}
                  className="px-4 py-2 rounded-md border border-slate-700 text-slate-300 hover:bg-slate-800"
                >
                  取消
                </button>
                <button
                  onClick={() => handlePay(selectedRequest)}
                  disabled={(!selectedRequest.paymentReceipt || (Array.isArray(selectedRequest.paymentReceipt) && selectedRequest.paymentReceipt.length === 0)) || !selectedRequest.paymentAccountId}
                  className="px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  确认支付
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 退回原因输入弹窗 */}
      {rejectModal.open && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
          <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 w-full max-w-md">
            <h2 className="text-xl font-semibold mb-4">退回原因</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-1">请输入退回原因 *</label>
                <textarea
                  value={rejectReason}
                  onChange={(e) => setRejectReason(e.target.value)}
                  rows={4}
                  className="w-full rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-slate-100 outline-none focus:border-primary-400"
                  placeholder="请详细说明退回原因..."
                  autoFocus
                />
              </div>
              <div className="flex gap-3 justify-end">
                <button
                  onClick={() => {
                    setRejectModal({ open: false, id: null });
                    setRejectReason("");
                  }}
                  className="px-4 py-2 rounded-md border border-slate-700 text-slate-300 hover:bg-slate-800"
                >
                  取消
                </button>
                <button
                  onClick={handleConfirmReject}
                  className="px-4 py-2 rounded-md bg-rose-500 text-white hover:bg-rose-600"
                >
                  确认退回
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
